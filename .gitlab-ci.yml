stages:
- build_base
- build
- test
- release

.docker: &docker
  image: docker:19.03-git
  services:
    - docker:19.03-dind
  variables:
    DOCKER_DRIVER: overlay2

.build: &build
  <<: *docker
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  after_script:
    - docker push "$BUILD_IMAGE_NAME"

# Test stage
shell check:
  image: koalaman/shellcheck-alpine:stable
  stage: test
  before_script:
    - shellcheck --version
  script:
    - shellcheck aws/src/bin/*

.test-command: &test-command
  stage: test
  image: $BUILD_IMAGE_NAME

# Release stage
.release-tag: &release-tag
  <<: *docker
  stage: release
  script:
    - 'echo ${CI_JOB_TOKEN} | docker login --password-stdin -u $CI_REGISTRY_USER $CI_REGISTRY'
    - echo "Using tag $CI_COMMIT_TAG for image"
    - docker pull "$BUILD_IMAGE_NAME"
    - docker tag "$BUILD_IMAGE_NAME" "$IMAGE_NAME_FOR_REGISTRY:latest"
    - docker tag "$BUILD_IMAGE_NAME" "$IMAGE_NAME_FOR_REGISTRY:$CI_COMMIT_TAG"
    - docker push "$IMAGE_NAME_FOR_REGISTRY:latest"
    - docker push "$IMAGE_NAME_FOR_REGISTRY:$CI_COMMIT_TAG"
  only:
    - tags

include:
  - local: /ci/aws-base.gitlab-ci.yml
  - local: /ci/aws-ecs.gitlab-ci.yml
  - local: /ci/aws-cloudformation.gitlab-ci.yml

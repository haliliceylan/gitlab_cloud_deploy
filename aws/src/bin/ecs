#!/bin/sh

update_task_definition() {
  family=$2
  new_image_name=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA

  current_task=$(aws ecs describe-task-definition --task-definition "$family")
  current_container_definitions=$(echo $current_task | jq '.taskDefinition.containerDefinitions')
  new_container_definitions=$(echo $current_container_definitions | jq --arg val $new_image_name '.[0].image = $val')

  new_task_definition=$(aws ecs register-task-definition --container-definitions "$new_container_definitions" --family "$family" --memory $MEMORY)

  new_task_revision=$(echo $new_task_definition | jq '.taskDefinition.revision')

  aws ecs update-service --cluster "$CLUSTER" --service "$SERVICE" --task-definition "$family":"$new_task_revision"
  return 0
}

option=$1
case $option in

  update-task-definition) update_task_definition "${@:2}" ;;
  *) exit 1 ;;
esac
